{% extends 'base.html' %} {% load static %} {% block styles %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}" />
<link
  href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
  rel="stylesheet"
/>
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
{% endblock %} {% block content %}
<div
  class="d-flex align-items-center justify-content-center min-vh-100"
  style="background-color: #f5f7fa"
>
  <div
    class="shadow-lg p-5 bg-white rounded"
    style="width: 100%; max-width: 500px; border-radius: 20px"
  >
    <div class="text-center mb-4">
      <h2 class="fw-bold text-danger">Sign Up & Assign RFID</h2>
      <p class="text-muted">
        Admin-only • Create the user and link their card UID
      </p>
    </div>

    {% if messages %} {% for message in messages %}
    <div class="alert alert-{{ message.tags }} mb-3" role="alert">
      {{ message }}
    </div>
    {% endfor %} {% endif %} {% if form.errors %}
    <div class="alert alert-danger">Please correct the errors below.</div>
    {% endif %}

    <form method="post" novalidate>
      {% csrf_token %}
      <div class="row">
        {% for field in form %}
        <div class="mb-3 col-md-12">
          <label for="{{ field.id_for_label }}" class="form-label"
            >{{ field.label }}</label
          >
          {{ field }} {% if field.help_text %}
          <div class="form-text">{{ field.help_text }}</div>
          {% endif %} {% if field.errors %}
          <div class="text-danger small">{{ field.errors.0 }}</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      <button type="submit" class="btn-login w-100">Sign Up</button>
    </form>

    <hr class="my-4" />
    <h5 class="fw-bold">Recent Scans</h5>
    <p class="text-muted small mb-2">
      Click a UID to auto-fill the “RFID Card UID” field.
    </p>
    <ul id="recent-list" class="list-group">
      <li class="list-group-item text-center text-muted">NO TAGS YET</li>
    </ul>

    <script>
      ;(function () {
        const list = document.getElementById('recent-list')
        const uidInput = document.getElementById('id_tag_uid')

        function wireCopyButtons() {
          document.querySelectorAll('.copy-uid-btn').forEach((btn) => {
            btn.onclick = () => {
              if (!uidInput) return
              uidInput.value = btn.dataset.uid
              uidInput.focus()
              uidInput.classList.add('is-valid')
              setTimeout(() => uidInput.classList.remove('is-valid'), 800)
            }
          })
        }

        async function fetchRecent() {
          try {
            const res = await fetch("{% url 'recent_unassigned_scans_api' %}", {
              credentials: 'same-origin'
            })
            if (!res.ok) return
            const data = await res.json()
            const items = data.items || []
            list.innerHTML = ''
            if (!items.length) {
              list.innerHTML =
                '<li class="list-group-item text-center text-muted">NO TAGS YET</li>'
            } else {
              items.forEach((s) => {
                const li = document.createElement('li')
                li.className =
                  'list-group-item d-flex justify-content-between align-items-center'
                const when = new Date(s.last_seen).toLocaleString()
                li.innerHTML = `
            <button type="button" class="btn btn-sm btn-outline-secondary copy-uid-btn" data-uid="${s.uid}">${s.uid}</button>
            <small class="text-muted">${when}</small>
          `
                list.appendChild(li)
              })
              wireCopyButtons()
            }
          } catch (e) {
            /* ignore */
          }
        }

        fetchRecent()
        setInterval(fetchRecent, 2000) // poll every 2s
      })()
    </script>
  </div>
</div>
{% endblock %}
