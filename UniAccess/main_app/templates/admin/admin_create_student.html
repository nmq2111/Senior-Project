{% extends 'base.html' %} {% load static %} {% load widget_tweaks %} {# Needed
for add_class filter #} {% block styles %}
<link rel="stylesheet" href="{% static 'css/styles.css' %}" />
<link
  href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
  rel="stylesheet"
/>
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
{% endblock %} {% block content %}
<div class="login-container">
  <div
    class="shadow-lg p-5 bg-white rounded"
    style="width: 100%; max-width: 900px; border-radius: 20px"
  >
    <div class="text-center mb-4">
      <h2 class="fw-bold text-danger">Create new Student</h2>
    </div>

    {% if messages %}
    <ul>
      {% for m in messages %}
      <li>{{ m }}</li>
      {% endfor %}
    </ul>
    {% endif %}

    <form method="post">
      {% csrf_token %} {{ form.non_field_errors }}

      <div class="row">
        <label>Username</label>
        {{ form.username }} {% if form.username.errors %}
        <div class="text-danger small mt-1">{{ form.username.errors }}</div>
        {% endif %}
      </div>

      <div class="row">
        <label>First Name</label>
        {{ form.first_name }} {% if form.first_name.errors %}
        <div class="text-danger small mt-1">{{ form.first_name.errors }}</div>
        {% endif %}
      </div>

      <div class="row">
        <label>Last Name</label>
        {{ form.last_name }} {% if form.last_name.errors %}
        <div class="text-danger small mt-1">{{ form.last_name.errors }}</div>
        {% endif %}
      </div>

      <div class="row">
        <label>Email</label>
        {{ form.email }} {% if form.email.errors %}
        <div class="text-danger small mt-1">{{ form.email.errors }}</div>
        {% endif %}
      </div>

      <div class="row">
        <label>Phone</label>
        {{ form.phone }} {% if form.phone.errors %}
        <div class="text-danger small mt-1">{{ form.phone.errors }}</div>
        {% endif %}
      </div>

      <div class="row">
        <label>Password</label>
        {{ form.password1 }} {% if form.password1.errors %}
        <div class="text-danger small mt-1">{{ form.password1.errors }}</div>
        {% endif %}
      </div>

      <div class="row">
        <label>Confirm Password</label>
        {{ form.password2 }} {% if form.password2.errors %}
        <div class="text-danger small mt-1">{{ form.password2.errors }}</div>
        {% endif %}
      </div>

      <div class="row">
        <label>Role</label>
        {{ form.role }} {% if form.role.errors %}
        <div class="text-danger small mt-1">{{ form.role.errors }}</div>
        {% endif %}
      </div>

      <div class="row">
        <label>College</label>
        {{ form.college }} {% if form.college.errors %}
        <div class="text-danger small mt-1">{{ form.college.errors }}</div>
        {% endif %}
      </div>

      <div class="row">
        <label>RFID UID (latest scans)</label>
        <div class="bar d-flex gap-2">
          {{ form.uid_choice|add_class:"form-select" }}
          <div class="text-danger small mt-1">{{ form.uid_choice.errors }}</div>
          <button
            type="button"
            id="refresh"
            class="btn btn-outline-secondary btn-sm"
          >
            Refresh
          </button>
        </div>
      </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-danger w-100">
          Create Student
        </button>
      </div>
    </form>

    <script>
      document.getElementById('refresh').addEventListener('click', async () => {
        try {
          const res = await fetch('{% url "latest_unassigned_uids" %}')
          const data = await res.json()
          const sel = document.querySelector('select[name="uid_choice"]')
          sel.innerHTML = ''
          const optNone = document.createElement('option')
          optNone.value = ''
          optNone.textContent = '— No tag —'
          sel.appendChild(optNone)
          for (const uid of data.uids) {
            const o = document.createElement('option')
            o.value = uid
            o.textContent = uid
            sel.appendChild(o)
          }
        } catch (e) {
          alert('Failed to refresh UIDs')
        }
      })
    </script>
  </div>
</div>
{% endblock %}
