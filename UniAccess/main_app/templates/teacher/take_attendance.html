{% extends "base.html" %} {% load tz %} {% block styles %}
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<style>
  .nowrap {
    white-space: nowrap;
  }
  code {
    background: #f6f8fa;
    padding: 0.1rem 0.35rem;
    border-radius: 4px;
  }
</style>
{% endblock %} {% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-danger mb-0">
      Take Attendance — <code>{{ ci.course.code }}</code> · {{ ci.class_name }}
    </h2>
    <a
      href="{% url 'teacher_attendance_list' %}"
      class="btn btn-outline-secondary btn-sm"
      >Back</a
    >
  </div>

  {% if messages %} {% for m in messages %}
  <div class="alert alert-{{ m.tags|default:'info' }} mb-2">{{ m }}</div>
  {% endfor %} {% endif %}

  <form method="get" class="mb-3 d-flex gap-2 align-items-end">
    <div>
      <label class="form-label">Date</label>
      <input
        type="date"
        name="date"
        value="{{ session_date|date:'Y-m-d' }}"
        class="form-control"
      />
    </div>
    <button class="btn btn-outline-danger">Go</button>
  </form>

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="date" value="{{ session_date|date:'Y-m-d' }}" />

    <div class="mb-2 d-flex gap-2">
      <button
        type="button"
        class="btn btn-sm btn-success"
        onclick="bulkMark('PRESENT')"
      >
        All Present
      </button>
      <button
        type="button"
        class="btn btn-sm btn-warning"
        onclick="bulkMark('LATE')"
      >
        All Late
      </button>
      <button
        type="button"
        class="btn btn-sm btn-secondary"
        onclick="bulkMark('ABSENT')"
      >
        All Absent
      </button>

      <form
        method="post"
        action="{% url 'finish_lecture' ci.id %}"
        class="inline"
      >
        {% csrf_token %}
        <input
          type="hidden"
          name="date"
          value="{{ session_date|date:'Y-m-d' }}"
        />
        <button type="submit" class="btn btn-sm btn-danger">
          Finish lecture (early checkout)
        </button>
      </form>
    </div>

    <div class="card shadow-sm">
      <div
        class="card-header bg-danger text-white d-flex justify-content-between"
      >
        <strong>Students ({{ enrollments|length }})</strong>
        <span class="text-white-50">{{ session_date }}</span>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Student</th>
              <th class="nowrap">Username / ID</th>
              <th class="nowrap">Status</th>
              <th class="nowrap">Existing</th>
            </tr>
          </thead>
          <tbody>
            {% for e in enrollments %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>
                {{ e.student.first_name }} {{ e.student.last_name }}
                <div class="text-muted small">{{ e.student.email }}</div>
              </td>
              <td class="nowrap">
                <code>{{ e.student.username }}</code> · {{e.student.custom_id}}
              </td>
              <td class="nowrap">
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input s-radio"
                    type="radio"
                    id="p{{ e.student_id }}"
                    name="status_{{ e.student_id }}"
                    value="PRESENT"
                  />
                  <label class="form-check-label" for="p{{ e.student_id }}"
                    >Present</label
                  >
                </div>
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input s-radio"
                    type="radio"
                    id="l{{ e.student_id }}"
                    name="status_{{ e.student_id }}"
                    value="LATE"
                  />
                  <label class="form-check-label" for="l{{ e.student_id }}"
                    >Late</label
                  >
                </div>
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input s-radio"
                    type="radio"
                    id="a{{ e.student_id }}"
                    name="status_{{ e.student_id }}"
                    value="ABSENT"
                  />
                  <label class="form-check-label" for="a{{ e.student_id }}"
                    >Absent</label
                  >
                </div>
              </td>
              <td class="nowrap">
                <span id="exist-{{ e.student_id }}" class="text-muted">—</span>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                No students enrolled.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card-footer d-flex justify-content-between">
        <div class="text-muted small">
          <code>{{ ci.course.code }}</code> · {{ ci.get_days_display }} ·
          {{ci.start_time|time:"H:i" }}–{{ci.end_time|time:"H:i" }}
        </div>
        <button type="submit" class="btn btn-danger">Save Attendance</button>
      </div>
    </div>
  </form>
</div>

<script>
  // Existing attendance map for this date/section (server-side rendered)
  const EXISTING = {
    {% for sid,att in existing.items %}
      "{{ sid }}": {
        "status": "{{ att.status }}",
        "first": "{{ att.first_seen|localtime|date:'H:i' }}",
        "last":  "{{ att.last_seen|localtime|date:'H:i' }}"
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  };

  // Preselect radios & fill the "Existing" column
  (function () {
    for (const [sid, info] of Object.entries(EXISTING)) {
      // preselect status radio
      const radioId = (info.status === "PRESENT" ? "p" : info.status === "LATE" ? "l" : "a") + sid;
      const r = document.getElementById(radioId);
      if (r) r.checked = true;

      // show existing badge/time
      const cell = document.getElementById("exist-" + sid);
      if (cell) {
        let badge = "";
        if (info.status === "PRESENT") badge = '<span class="badge text-bg-success">Present</span>';
        else if (info.status === "LATE") badge = '<span class="badge text-bg-warning text-dark">Late</span>';
        else badge = '<span class="badge text-bg-secondary">Absent</span>';
        cell.innerHTML = badge + ' <span class="text-muted small">' + info.first + '–' + info.last + '</span>';
      }
    }
  })();

  function bulkMark(status) {
    document.querySelectorAll(".s-radio").forEach(r => {
      if (r.value === status) r.checked = true;
    });
  }
</script>
{% endblock %}
