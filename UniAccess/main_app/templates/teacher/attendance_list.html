{% extends "base.html" %}
{% load tz %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  .nowrap { white-space: nowrap; }
  code { background:#f6f8fa; padding:.1rem .35rem; border-radius:4px; }
  .course-header { font-weight:600; margin-bottom:.25rem; }
  .sec-chip { display:inline-flex; align-items:center; gap:.5rem; margin:.25rem .5rem .25rem 0; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-danger mb-0">My Attendance</h2>
    <div>
    <a href="{% url 'teacher_attendance_list' %}" class="btn btn-outline-secondary btn-sm">Refresh</a>
    <a href="{% url 'attendance_take_C' %}" class="btn btn-outline-danger btn-sm">Take</a>
  </div>
    
  </div>

  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-{{ m.tags|default:'info' }} mb-2">{{ m }}</div>
    {% endfor %}
  {% endif %}
</div>



  {# -------------------- Filters (existing) -------------------- #}
  <form method="get" class="row g-2 align-items-end mb-3">
    <input type="hidden" name="date" value="{{ session_date|date:'Y-m-d' }}">
    <div class="col-auto">
      <label class="form-label">Search</label>
      <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="student / code / course name" />
    </div>
    <div class="col-auto">
      <label class="form-label">Status</label>
      <select name="status" class="form-select">
        <option value="">All</option>
        {% for val,label in status_opts %}
          <option value="{{ val }}" {% if status == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">Section</label>
      <select name="course_info" class="form-select">
        <option value="">All</option>
        {% for s in section_opts %}
          <option value="{{ s.id }}" {% if section_id|stringformat:'s' == s.id|stringformat:'s' %}selected{% endif %}>
            {{ s.course__code }} – {{ s.class_name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">From</label>
      <input type="date" name="start" value="{{ start }}" class="form-control" />
    </div>
    <div class="col-auto">
      <label class="form-label">To</label>
      <input type="date" name="end" value="{{ end }}" class="form-control" />
    </div>
    <div class="col-auto">
      <label class="form-label">Sort</label>
      <select name="order" class="form-select">
        <option value="-session_date" {% if order == '-session_date' %}selected{% endif %}>Date ↓</option>
        <option value="session_date"  {% if order == 'session_date' %}selected{% endif %}>Date ↑</option>
        <option value="-first_seen"   {% if order == '-first_seen' %}selected{% endif %}>First seen ↓</option>
        <option value="first_seen"    {% if order == 'first_seen' %}selected{% endif %}>First seen ↑</option>
        <option value="student__username"  {% if order == 'student__username' %}selected{% endif %}>Student ↑</option>
        <option value="-student__username" {% if order == '-student__username' %}selected{% endif %}>Student ↓</option>
        <option value="course_info__course__code"  {% if order == 'course_info__course__code' %}selected{% endif %}>Code ↑</option>
        <option value="-course_info__course__code" {% if order == '-course_info__course__code' %}selected{% endif %}>Code ↓</option>
      </select>
    </div>
    <div class="col-auto d-flex gap-2">
      <button class="btn btn-outline-danger">Apply</button>
      <a class="btn btn-outline-secondary" href="{% url 'teacher_attendance_list' %}?date={{ session_date|date:'Y-m-d' }}">Clear</a>
    </div>
  </form>

  {# -------------------- Attendance Table (existing) -------------------- #}
  <div class="card shadow-sm">
    <div class="card-header bg-danger text-white d-flex justify-content-between">
      <strong>Attendance Records</strong>
      <span class="text-white-50">Total: {{ records|length }}</span>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0 align-middle">
        <thead>
          <tr>
            <th class="nowrap">Date</th>
            <th>Student</th>
            <th>Code</th>
            <th>Class</th>
            <th class="nowrap">Status</th>
            <th class="nowrap">First seen</th>
            <th class="nowrap">Last seen</th>
            <th class="nowrap">Edit</th>
          </tr>
        </thead>
        <tbody>
          {% for a in records %}
          <tr>
            <td class="nowrap">{{ a.session_date }}</td>
            <td>
              {{ a.student.custom_id }}
              <div class="text-muted small">
                {{ a.student.first_name }} {{ a.student.last_name }} · <code>{{ a.student.username }}</code>
              </div>
            </td>
            <td class="nowrap"><code>{{ a.course_info.course.code }}</code></td>
            <td class="nowrap">{{ a.course_info.class_name }}</td>
            <td class="nowrap">
              {% if a.status == "PRESENT" %}
                <span class="badge text-bg-success">Present</span>
              {% elif a.status == "LATE" %}
                <span class="badge text-bg-warning text-dark">Late</span>
              {% else %}
                <span class="badge text-bg-secondary">Absent</span>
              {% endif %}
            </td>
            <td class="nowrap">{{ a.first_seen|localtime|date:"Y-m-d H:i" }}</td>
            <td class="nowrap">{{ a.last_seen|localtime|date:"Y-m-d H:i" }}</td>
            <td class="nowrap">
              <a href="{% url 'teacher_attendance_edit' a.id %}" class="btn btn-sm btn-outline-secondary">Edit</a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="9" class="text-center text-muted">No records found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}
