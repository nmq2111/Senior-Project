{% extends 'base.html' %} {% load tz %} {% block styles %}
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<style>
  .nowrap {
    white-space: nowrap;
  }
  code {
    background: #f6f8fa;
    padding: 0.1rem 0.35rem;
    border-radius: 4px;
  }
  .stat {
    padding: 12px 16px;
    border: 1px solid #dee2e6;
    border-radius: 12px;
  }
  .stat small {
    color: #6c757d;
  }
  .table td,
  .table th {
    vertical-align: middle;
  }
</style>
{% endblock %} {% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-danger mb-0">Teacher Dashboard</h2>
    <div class="text-muted">As of {{ today|date:"Y-m-d" }}</div>
  </div>

  {# Top: Take Attendance (today) #}
  <div class="card shadow-sm mb-4">
    <div
      class="card-header bg-danger text-white d-flex justify-content-between align-items-center"
    >
      <strong>Take Attendance (Today)</strong>
      <a href="{% url 'teacher_attendance_list' %}" class="btn btn-light btn-sm"
        >View All Attendance</a
      >
    </div>
    <div class="card-body">
      {% if todays_sections %}
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Code</th>
              <th>Course / Class</th>
              <th class="nowrap">Section</th>
              <th class="nowrap">Time</th>
              <th class="nowrap">Type</th>
              <th class="text-center nowrap">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for ci in todays_sections %}
            <tr>
              <td class="nowrap"><code>{{ ci.course.code }}</code></td>
              <td>
                {{ ci.course.name }}
                <div class="text-muted small">{{ ci.class_name }}</div>
              </td>
              <td class="nowrap">#{{ ci.section|default:"—" }}</td>
              <td class="nowrap">
                {{ ci.start_time|time:"H:i" }}–{{ ci.end_time|time:"H:i" }}
              </td>
              <td class="nowrap">{{ ci.get_session_type_display }}</td>
              <td class="text-center">
                <a
                  class="btn btn-danger btn-sm"
                  href="{% url 'teacher_take_attendance' ci.id %}?date={{ today|date:'Y-m-d' }}"
                  >Take Attendance</a
                >
                <a
                  class="btn btn-outline-secondary btn-sm ms-1"
                  href="{% url 'teacher_userbase' %}"
                  >Students</a
                >
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if next_class %}
      <div class="text-muted small mt-2">
        Next:
        <code>{{ next_class.course.code }}</code>
        {{next_class.start_time|time:"H:i" }}
      </div>
      {% endif %} {% else %}
      <div class="text-muted">No sections scheduled today.</div>
      {% endif %}
    </div>
  </div>

  {# Stats #}
  <div class="row g-3 mb-4">
    <div class="col-sm-4">
      <div class="stat">
        <small>Sections</small>
        <h4>{{ total_sections }}</h4>
      </div>
    </div>
    <div class="col-sm-4">
      <div class="stat">
        <small>Total Students</small>
        <h4>{{ total_students }}</h4>
      </div>
    </div>
    <div class="col-sm-4">
      <div class="stat">
        <small>Attendance Today</small>
        <div>
          <strong>{{ today_present }}</strong> Present ·
          <strong>{{ today_late }}</strong> Late ·
          <strong>{{ today_absent }}</strong> Absent
        </div>
      </div>
    </div>
  </div>

  {# Charts #}
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-danger text-white">
          <strong>Last 30 Days — Attendance</strong>
        </div>
        <div class="p-3">
          <canvas id="attPie" height="200"></canvas>
          {{ att_pie|json_script:"att-pie-data" }}
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-danger text-white">
          <strong>Warning Levels</strong>
        </div>
        <div class="p-3">
          <canvas id="warnBars" height="200"></canvas>
          {{ warn_bars|json_script:"warn-bars-data" }}
        </div>
      </div>
    </div>
  </div>

  {# Recent attendance #}
  <div class="row g-3">
    <div class="col-lg-7">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-danger text-white">
          <strong>Recent Attendance</strong>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead>
              <tr>
                <th>Date</th>
                <th>Student</th>
                <th>Code</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for a in recent_attendance %}
              <tr>
                <td class="nowrap">{{ a.session_date|date:"Y-m-d" }}</td>
                <td>
                  {{ a.student.first_name }} {{ a.student.last_name }}
                  <div class="text-muted small">
                    <code>{{ a.student.username }}</code>
                  </div>
                </td>
                <td class="nowrap">
                  <code>{{ a.course_info.course.code }}</code>
                </td>
                <td class="nowrap">
                  {% if a.status == 'PRESENT' %}<span
                    class="badge text-bg-success"
                    >Present</span
                  >
                  {% elif a.status == 'LATE' %}<span
                    class="badge text-bg-warning text-dark"
                    >Late</span
                  >
                  {% else %}<span class="badge text-bg-secondary">Absent</span
                  >{% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted">
                  No attendance yet.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-danger text-white">
          <strong>Recent Scans</strong>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead>
              <tr>
                <th>When</th>
                <th>UID</th>
                <th class="text-muted">Note</th>
              </tr>
            </thead>
            <tbody>
              {% for s in recent_scans %}
              <tr>
                <td class="nowrap">
                  {{ s.created_at|localtime|date:"Y-m-d H:i" }}
                </td>
                <td><code>{{ s.uid }}</code></td>
                <td class="text-muted small">{{ s.extra.note|default:"" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center text-muted">
                  No scans yet.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  {# My Week (by day buckets) #}
  <div class="card shadow-sm mt-4">
    <div class="card-header bg-danger text-white"><strong>My Week</strong></div>
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0">
        <thead>
          <tr>
            <th>UTH</th>
            <th>MW</th>
            <th>FS</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              {% for ci in week_groups.uth %}
              <div class="mb-2">
                <code>{{ ci.course.code }}</code
                >{{ci.start_time|time:"H:i"}}–{{ci.end_time|time:"H:i"}}
                <div class="text-muted small">
                  {{ ci.course.name }} · #{{ ci.section|default:"—" }}
                </div>
              </div>
              {% empty %}<span class="text-muted">—</span>{% endfor %}
            </td>
            <td>
              {% for ci in week_groups.mw %}
              <div class="mb-2">
                <code>{{ci.course.code }}</code>
                {{ci.start_time|time:"H:i"}}–{{ci.end_time|time:"H:i" }}
                <div class="text-muted small">
                  {{ci.course.name }} · #{{ci.section|default:"—" }}
                </div>
              </div>
              {% empty %}<span class="text-muted">—</span>{% endfor %}
            </td>
            <td>
              {% for ci in week_groups.fs %}
              <div class="mb-2">
                <code>{{ci.course.code }}</code>
                {{ci.start_time|time:"H:i"}}–{{ci.end_time|time:"H:i" }}
                <div class="text-muted small">
                  {{ci.course.name }} · #{{ci.section|default:"—" }}
                </div>
              </div>
              {% empty %}<span class="text-muted">—</span>{% endfor %}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

{# Chart.js #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  ;(function () {
    const pieData = JSON.parse(
      document.getElementById('att-pie-data').textContent
    )
    const barData = JSON.parse(
      document.getElementById('warn-bars-data').textContent
    )

    const pieCtx = document.getElementById('attPie').getContext('2d')
    new Chart(pieCtx, {
      type: 'pie',
      data: { labels: pieData.labels, datasets: [{ data: pieData.data }] },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    })

    const barCtx = document.getElementById('warnBars').getContext('2d')
    new Chart(barCtx, {
      type: 'bar',
      data: { labels: barData.labels, datasets: [{ data: barData.data }] },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    })
  })()
</script>
{% endblock %}
