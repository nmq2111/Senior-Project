{% extends 'base.html' %} {% load tz %} {% block styles %}
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>

{% endblock %} {% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0" style="color: #d10e0e">Dashboard</h2>
    <div class="text-muted" style="color: #d10e0e">
      Local time: {{ now|date:"Y-m-d H:i" }}
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-4">
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card card-body">
        <div class="num" style="color: #d10e0e">{{ counts.students }}</div>
        <div class="lbl">Students</div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card card-body">
        <div class="num" style="color: #d10e0e">{{ counts.teachers }}</div>
        <div class="lbl">Teachers</div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card card-body">
        <div class="num" style="color: #d10e0e">{{ counts.courses }}</div>
        <div class="lbl">Courses</div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card card-body">
        <div class="num" style="color: #d10e0e">{{ counts.sections }}</div>
        <div class="lbl">Sections</div>
      </div>
    </div>

    <div class="col-sm-6 col-lg-3">
      <div class="kpi card card-body">
        <div class="num" style="color: #d10e0e">{{ counts.enrollments }}</div>
        <div class="lbl">Enrollments</div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card card-body">
        <div class="num" style="color: #d10e0e">
          {{ counts.tags_assigned }}/{{ counts.tags_total }}
        </div>
        <div class="lbl">Tags assigned</div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card card-body">
        <div class="num" style="color: #d10e0e">{{ counts.scans_today }}</div>
        <div class="lbl">Scans today</div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card card-body">
        <div class="num" style="color: #d10e0e">
          {{ counts.unknown_scans_today }}
        </div>
        <div class="lbl">Unknown scans today</div>
      </div>
    </div>
  </div>

  <!-- Charts row -->
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm mb-5">
        <div
          class="card-header bg-danger text-white d-flex justify-content-between"
        >
          Attendance today
        </div>
        <div class="card-body">
          <canvas id="attPie" height="200"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm mb-5">
        <div
          class="card-header bg-danger text-white d-flex justify-content-between"
        >
          Scans by hour (today)
        </div>
        <div class="card-body">
          <canvas id="scansLine" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Active sections & right column -->
  <div class="row g-3">
    <div class="col-lg-7">
      <div class="card shadow-sm mb-5">
        <div
          class="card-header bg-danger text-white d-flex justify-content-between"
        >
          <span>Active sections now</span>
          <a class="small" href="{% url 'courseInfo_list' %}">All sections →</a>
        </div>
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead>
              <tr>
                <th>Code</th>
                <th>Course / Class</th>
                <th>Teacher</th>
                <th class="nowrap">Time</th>
              </tr>
            </thead>
            <tbody>
              {% for ci in active_sections %}
              <tr>
                <td><code>{{ ci.course.code }}</code></td>
                <td>
                  {{ ci.course.name }}
                  <div class="text-muted small">{{ ci.class_name }}</div>
                </td>
                <td>
                  {% if ci.teacher.first_name or ci.teacher.last_name %}
                  <div>{{ ci.teacher.first_name }}</div>
                  {{ ci.teacher.last_name }} {% else %} {{ ci.teacher.username
                  }} {% endif %}
                </td>
                <td class="nowrap">
                  {{ ci.start_time|time:"H:i" }}–{{ ci.end_time|time:"H:i" }}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted">
                  No active sections right now.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm mb-5">
        <div
          class="card-header bg-danger text-white d-flex justify-content-between"
        >
          <span>Recent unknown scans (today)</span>
          <a class="small" href="{% url 'attendance_list' %}">Attendance →</a>
        </div>
        <ul class="list-group list-group-flush">
          {% for s in recent_unknown_scans %}
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            <span
              ><code>{{ s.uid }}</code>
              <span class="text-muted small"
                >({{ s.device_id|default:"—" }})</span
              ></span
            >
            <span class="text-muted small"
              >{{ s.created_at|localtime|date:"H:i" }}</span
            >
          </li>
          {% empty %}
          <li class="list-group-item text-muted">No unknown scans today.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="card shadow-sm mb-5">
        <div
          class="card-header bg-danger text-white d-flex justify-content-between"
        >
          Students without tags
        </div>
        <ul class="list-group list-group-flush">
          {% for u in tagless_students %}
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            <span
              >{{ u.username }}
              <span class="text-muted small">
                {% if u.first_name or u.last_name %} · {{ u.first_name }} {{
                u.last_name }}{% endif %} {% if u.custom_id %} ·
                <code>{{ u.custom_id }}</code>{% endif %}
              </span>
            </span>
            <a
              class="btn btn-sm btn-outline-danger"
              href="{% url 'users_directory' %}"
              >assign</a
            >
          </li>
          {% empty %}
          <li class="list-group-item text-muted">All students have tags</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // Attendance pie
  const attPieData = {{ att_pie_json|safe }};
  const ctxPie = document.getElementById('attPie').getContext('2d');
  new Chart(ctxPie, {
    type: 'pie',
    data: {
      labels: attPieData.labels,
      datasets: [{ data: attPieData.data }]
    },
    options: { plugins: { legend: { position: 'bottom' } } }
  });

  // Scans by hour line
  const hourLabels = {{ scans_hour_labels_json|safe }};
  const hourCounts = {{ scans_hour_counts_json|safe }};
  const ctxLine = document.getElementById('scansLine').getContext('2d');
  new Chart(ctxLine, {
    type: 'line',
    data: {
      labels: hourLabels,
      datasets: [{ label: 'Scans', data: hourCounts, tension: 0.3 }]
    },
    options: {
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
      plugins: { legend: { display: false } }
    }
  });
</script>

{% endblock %}
